---
title: "ggplot2の辞書"
author: "やわらかクジラ"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output: 
  html_document: 
    toc: TRUE
    toc_float: true
    toc_depth: 4
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


# 辞書作成進捗

* 初期状態: 16チャンク(内非グラフ部分2チャンク)  
* 完了/追加予定  **36/`r 46+15*2`**チャンク  
  + 追加予定数は2020/07/11 現在


# 辞書の説明

## 概要

* データの可視化と細かい部分の微調整をするための備忘録
* 気になる用語や関数について`ctrl + F`で検索

## 参考情報
* [公式のレファレンス](https://ggplot2.tidyverse.org/reference/index.html)
   + 各関数と引数の意味がグラフ付きで解説されている

* [ggplot2: Elegant Graphics for Data Analysis](https://ggplot2-book.org/)
  + by Hadley Wickham
  
* [R Graphics Cookbook, 2nd edition](https://r-graphics.org/)
  + by Winston Chang
   
# 散布図(1): 2変数のみ
## デフォルトの図

* R for Data Scienceにならって、mpgデータを使用  
  + https://r4ds.had.co.nz/data-visualisation.html#first-steps  
* mpgデータ  
  + 車の人気モデル38種類における燃料効率データ（1999-2008年）
* 使用変数の説明
  + `displ`: エンジンの排気量（リットル）  
  + `hwy`:   燃料効率（miles per gallon[mpg]）

```{r}
library(tidyverse)
```

```{r}
p <- 
ggplot(mpg, aes(x = displ, y = hwy))

p + geom_point() 
```

## 点の書式
### 色
```{r}
p +
  geom_point(color = "deepskyblue3") 
```

### 大きさ


```{r}
p +
  geom_point(size = 3) 
```

### 濃さ（透明度）
```{r}
p +
  geom_point(alpha = 0.1) 
```
### 形

* 他の形は`vignette("ggplot2-specs")`のshapeを参考
* 例
  + ■："square"
  + ♦："diamond"
  + △："triangle open"
  + ×："cross" 
  

```{r}
p +
  geom_point(shape = "triangle") 
```


## タイトルと軸: labs()
### タイトル
```{r}
p +
  geom_point() +
  labs(
    title = "タイトル",
    subtitle = "サブタイトル",
    caption = "キャプション(短い説明文）"
       )
```

#### タイトルの文字サイズ変更
```{r}
p +
  geom_point() +
  labs(
    title = "タイトル",
    subtitle = "サブタイトル",
    caption = "キャプション(短い説明文）"
       ) +
  theme(
    plot.title    = element_text(size = 30),
    plot.subtitle = element_text(size = 20),
    plot.caption  = element_text(size = 15)
  )
```

#### タイトルを太字にして色をつける
```{r}
p +
  geom_point() +
  labs(
    title = "タイトル") +
  theme(
    plot.title    = element_text(size = 30,
                                 face = "bold",      # 太字
                                 color = "darkblue") # 色
  )
```

#### タイトルの位置変更
```{r}
p +
  geom_point() +
  labs(
    title = "タイトル",
    subtitle = "サブタイトル",
    caption = "キャプション(短い説明文）"
       ) +
  theme(
    plot.title    = element_text(hjust = 0.5),   # 水平方向0-1の範囲で相対的な位置を指定
    plot.subtitle    = element_text(hjust = 0.5),
    plot.caption  = element_text(hjust = 0)
  )
```


### 軸の名前

* 名前を消したいときは `x = ""`のようにしてもできる

```{r}
p +
  geom_point() +
  labs(
    x = "x軸の名前",
    y = "y軸の名前"
       )
```


## 軸の数値範囲: scale_continuous()  
### 数値範囲確認
```{r}
mpg %>% 
  select(displ, hwy) %>% # displとhwyを選んでsummary()に渡す
  summary()
```

### 範囲を指定して１ずつ増やす

* 数値型の場合は、`scale_x_continuous()`および`scale_y_continuous()`のbreaksで指定
* 表示範囲を強制指定する場合は`limits =` 

```{r}
p +
  geom_point() +
  scale_x_continuous(
    breaks = seq(from = 1, to = 8, by = 1), # 1から8まで1ずつ増える
    limits = c(1, 8)) +                     # 1を表示したい場合
  scale_y_continuous(
    breaks = seq(from = 10, to = 45, by = 5), # 10から45まで5ずつ増える
    limits = c(10, 45))
```


#### 手動で指定
```{r}
p +
  geom_point() +
  scale_y_continuous(
    breaks = c(15, 30, 45))       
```

## 軸の数値のサイズ
```{r}
p +
  geom_point() +
  theme(axis.text = element_text(size = 9)) # 単位はpt

p + 
  geom_point() +
  theme(axis.text = element_text(size = 12)) # 単位はpt

p +
  geom_point() +
  theme(axis.text = element_text(size = 16)) # 単位はpt

```


## グラフ中に線やテキストを追加
### 横線: geom_hline()
```{r}
p + 
  geom_point() +
  geom_hline(yintercept = 30,     # 座標の位置
             linetype = "dotted", # 点線
             color = "red",       # 色
             size = 1)            # 大きさ

```

### 縦線:geom_vline()
```{r}
p +
  geom_point() +
  geom_vline(xintercept = 5,
             linetype = "dotted",
             color = "red",
             size = 1)

```

### テキスト: annotate()
```{r}
p +
  geom_point() +
  annotate(geom = "text",
           x = 5, y = 35,  # テキストの中心座標位置
           label = "ここにテキスト",
           color = "blue",
           size = 10)
```

#### 相関係数を入れる

* 部分的にイタリックにする場合
  + rを`italic()`で囲む
  + `parse = TRUE`を入れる
  + `=`を表示する場合`==`と入れる 

```{r}
# 相関係数の計算
corc <- 
  cor(mpg$displ, mpg$hwy) %>% 
  round(2)
 
p +
  geom_point() +
  annotate("text",
           label = str_c("italic(r) == ", corc), # 相関係数の代入 
           parse = TRUE,
           x = 6, y = 40,
           size = 6)
  
```



## 背景の色や線のテンプレート変更 

```{r}
p + 
  geom_point() +
  theme_bw()
```

```{r}
p +
  geom_point() +
  theme_classic()
```


## ジッター入り
```{r}
p +
  geom_jitter()
```

### ジッターの調整
```{r}
p +
  geom_jitter(width = 0.5, height = 0.5)
```


## データ数によって点の大きさを変える
```{r}
p +
  geom_count()
```


# 散布図(2): 3変数以上
## 色分け

* 使用変数の説明
  + `class`: 車種

```{r}
pc <- 
ggplot(mpg, aes(displ, hwy,
                color = class))

pc + geom_point()
```

### 色を手動で指定
```{r}
pc +
  geom_point() +
  scale_color_manual(values = c("red", "green", "blue", "yellow", "pink", "black", "brown"))
```


#### 凡例の名前変更
```{r}
pc +
  geom_point() +
  scale_color_manual(values = c("red", "green", "blue", "yellow", "pink", "black", "brown"),
                     labels = c("二人乗り","小型","中型","ミニバン","貨物","サブコンパクト","SUV"))
```

### 用意された色のセットを使用

* 詳しくは`?scale_color_brewer`
* ユニバーサルカラーのセット例
  + Set2  （8色まで）
  + Paired（12色まで）
  + Dark2 （8色まで）

```{r}
pc +
  geom_point() +
  scale_color_brewer(palette = "Set2")
```


## 凡例の調整
### 凡例の位置
```{r}
pc +
 geom_point() +
 theme(legend.position = "bottom")

```

### 凡例を消す
```{r}
pc +
 geom_point() +
 theme(legend.position = "none")

```

### 凡例をグラフ中に

* `legend.position =` で、x軸、y軸のそれぞれを0-1の範囲で表した相対的な位置の座標で表す
* `legend.direction = "horizontal"`で、凡例を横向きに展開

```{r}
pc +
 geom_point() +
 theme(legend.position = c(.70, .80),
       legend.direction = "horizontal")

```

### 凡例の行数や列数指定
```{r}
pc +
 geom_point() +
 theme(legend.position = "bottom") +
 guides(color = guide_legend(nrow = 1))  

```

### 凡例の順序を逆に
```{r}
pc +
 geom_point() +
 guides(color = guide_legend(reverse = TRUE))
```

### 凡例の順序を任意に
```{r}
# class別のエンジンの排気量平均を確認して並び替え
mpg %>% 
  group_by(class) %>%
  summarise(mean_hwy = mean(hwy)) %>% 
  arrange(mean_hwy)

pc +
 geom_point() +
  scale_color_discrete(breaks =                       # 色分けをcolorでやっているのでscale_color
                        c("pickup", "suv", "minivan", 
                          "2seater", "midsize", "subcompact", "compact"))
```

#### 因子にして順序を指定する場合

* ここでは同時に実行しているが、そもそものデータフレームで因子型で順序を指定し作成しておけばその順序が反映される

```{r}
mpg %>% 
  mutate(class = fct_relevel(class,
                             "pickup", "suv", "minivan", 
                          "2seater", "midsize", "subcompact", "compact")) %>% 
ggplot(aes(displ, hwy,
                color = class)) +
  geom_point()

```



## 点をテキストで表示:geom_text
```{r}
pc +
  geom_text(aes(label = class), show.legend = FALSE) # 凡例なし
```

### 重なりをなくす
```{r}
pc +
  geom_text(aes(label = class), show.legend = FALSE,
            check_overlap = TRUE ) # 凡例なし
```

### 斜めにする
```{r}
pc +
  geom_text(aes(label = class), show.legend = FALSE,
            angle = 45 ) # 凡例なし
```


## 変数の水準ごとにプロット: facet_wrap()
```{r}
pc +
   geom_point() +
   facet_wrap(vars(class))
```

### 並べ方指定

* 列数： ncol = 数字
* 行数： nrow = 数字

```{r}
pc +
   geom_point() +
   facet_wrap(vars(class),
             ncol = 2)
```


# 折れ線グラフ:geom_line()
## ある平均値の年次推移をグループ別にプロットしたい場合
### 必要な形のデータを作成
```{r}
library(knitr) # kable()を使うため

# 車種(class)と年次別の燃料効率(hwy)平均値データを作成
comp_hwy_y <- 
mpg %>% 
  group_by(class, year) %>% 
  summarise(mean_hwy = mean(hwy))

kable(comp_hwy_y)
```

#### (参考)wideからlongへのデータ構造変換

##### 参考のためにwide型作成
```{r}
comp_hwy_y_w <-
  comp_hwy_y %>% 
  pivot_wider(names_from = year,
              values_from = mean_hwy)

kable(comp_hwy_y_w)
  
```

* このようなデータ（wide型）があったらlong型に変換する

##### long型に
```{r}
comp_hwy_y_w %>% 
  pivot_longer(-class,            # この変数以外、つまり1999と2008の列を使用
               names_to = "year",
               values_to = "mean_hwy")
```



### 作図
```{r}
ggplot(comp_hwy_y, 
       aes(year, mean_hwy, color = class)) +
  geom_line()
```

#### 使用した年のみのx軸の表示にしデータ点を追加する
```{r}
ggplot(comp_hwy_y, 
       aes(year, mean_hwy, color = class)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = c(1999, 2008))
```

## 日付の軸表示

R for Data Science 
[24 Model building > 24.3 What affects the number of daily flights?](https://bookdown.org/roy_schumacher/r4ds/model-building.html#what-affects-the-number-of-daily-flights) より

  
### グラフ用のデータ作成（日別の便数作成と曜日の変数追加）
```{r}
library(nycflights13) # 
library(lubridate)    # 

# 日別の便数  
daily <- flights %>% 
    mutate(date = make_date(year, month, day)) %>% 
    group_by(date) %>% 
    summarise(n = n())

head(daily)  


# 曜日変数追加  
daily <- daily %>% 
    mutate(wday = wday(date, label = TRUE))    
``` 

#### 土曜日のデータに限定
```{r}
ds <- 
daily %>% 
    filter(wday == "土") %>% 
 ggplot(aes(date, n)) +
    geom_line()

ds
```

### ラベルの表示調整

* `date_labels =`の後に指定する文字の意味は`?strptime`を参照
* 教科書ggplot2: Elegant Graphics for Data Analysisでは
  + [13 Guides: legends and axes > 13.2.3 Dates: A special case](https://ggplot2-book.org/guides.html#date-scales)  


#### 月ごと

* ※ %bで数字のみが出てくる問題については、いずれ検討（おそらくlocaleの問題）

```{r}
ds +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") # 本来はJanなどの月名の省略文字 
```

#### 半年ごと
```{r}
ds +
  scale_x_date(date_breaks = "6 month", date_labels = "%Y/%b") # 西暦/月
```

# 棒グラフ(要約値から作る):geom_col()

* 折れ線グラフの時と同一データを使用
  + 1999年データに限定

## デフォルトの図
```{r}
pb <- 
comp_hwy_y %>% 
  filter(year == 1999) %>% 
  ggplot(aes(x = class, y = mean_hwy)) +
  geom_col()

pb
```

### x軸の順番を任意に
```{r}
comp_hwy_y %>% 
  filter(year == 1999) %>% 
  ggplot(aes(
    　　　　　fct_relevel(class,
                         "pickup", "suv", "minivan", 
                        "2seater", "midsize", "subcompact", "compact"), 
             mean_hwy)) +
  geom_col() +
  labs(x = "class")



```

